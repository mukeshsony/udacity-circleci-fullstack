version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:20.17-browsers   # Next-gen image with Node + Chrome for Angular tests
    working_directory: ~/repo

jobs:
  # -------------------------
  # Frontend Build & Test
  # -------------------------
  frontend-job:
    executor: node-executor
    steps:
      - checkout

      # Restore frontend dependencies cache
      - restore_cache:
          keys:
            - v1-frontend-node-{{ checksum "web-app/package-lock.json" }}

      - run:
          name: Install Frontend Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing frontend dependencies..."
            echo "=========================================="
            cd web-app
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            ls -lh package.json package-lock.json
            npm ci --loglevel=info
            echo "‚úÖ Dependencies installed"
            ls -ld node_modules
            ls -l node_modules/.bin | head -10 || echo ".bin folder missing"

      # Save frontend node_modules cache
      - save_cache:
          paths:
            - web-app/node_modules
          key: v1-frontend-node-{{ checksum "web-app/package-lock.json" }}

      # Run frontend tests (ChromeHeadlessCI)
      - run:
          name: Run Frontend Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running frontend unit tests..."
            echo "=========================================="
            cd web-app
            export CHROME_BIN=$(which google-chrome-stable || which google-chrome)
            echo "Chrome binary: $CHROME_BIN"
            echo "Checking Angular CLI:"
            ls -lh node_modules/.bin/ng
            npx ng version
            echo ""
            echo "Running tests..."
            npm run test:ci
            echo "‚úÖ Tests completed"

      # Build frontend
      - run:
          name: Build Frontend
          command: |
            echo "=========================================="
            echo "üèó Building frontend..."
            echo "=========================================="
            cd web-app
            echo "Building with Angular CLI..."
            npm run build
            echo "‚úÖ Build completed"
            echo "Build output:"
            ls -lh dist/
            du -sh dist/

      # Cache frontend build artifacts
      - save_cache:
          paths:
            - web-app/dist
          key: v1-frontend-build-{{ checksum "web-app/package-lock.json" }}

  # -------------------------
  # Backend Build & Test
  # -------------------------
  backend-job:
    executor: node-executor
    steps:
      - checkout

      # Restore backend dependencies cache
      - restore_cache:
          keys:
            - v1-backend-node-{{ checksum "web-api/package-lock.json" }}

      - run:
          name: Install Backend Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing backend dependencies..."
            echo "=========================================="
            cd web-api
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            npm ci --loglevel=info
            echo "‚úÖ Dependencies installed"
            ls -ld node_modules
            ls -l node_modules/.bin | head -10 || echo ".bin folder missing"

      # Save backend node_modules cache
      - save_cache:
          paths:
            - web-api/node_modules
          key: v1-backend-node-{{ checksum "web-api/package-lock.json" }}

      # Run backend tests
      - run:
          name: Run Backend Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running backend unit tests..."
            echo "=========================================="
            cd web-api
            npm test

      # Build backend
      - run:
          name: Build Backend
          command: |
            echo "=========================================="
            echo "üèó Building backend..."
            echo "=========================================="
            cd web-api
            npm run build
            if [ -d dist ]; then
              echo "Build output:"
              ls -lh dist/
              du -sh dist/
            fi

      # Cache backend build artifacts
      - save_cache:
          paths:
            - web-api/dist
          key: v1-backend-build-{{ checksum "web-api/package-lock.json" }}

  # -------------------------
  # Frontend Deploy
  # -------------------------
  deploy-frontend:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Deploy Frontend
          command: |
            echo "=========================================="
            echo "üöÄ Deploying frontend..."
            echo "=========================================="
            cd web-app/dist
            ls -lh
            if [ -f .cache_deploy_done ]; then
              echo "‚ö†Ô∏è  Frontend deploy cache exists, skipping deploy"
            else
              aws s3 sync . s3://${AWS_S3_BUCKET} --delete
              aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --paths "/*"
              touch .cache_deploy_done
              echo "‚úÖ Frontend deployed successfully"
            fi

  # -------------------------
  # Backend Deploy
  # -------------------------
  deploy-backend:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Deploy Backend
          command: |
            echo "=========================================="
            echo "üöÄ Deploying backend..."
            echo "=========================================="
            cd web-api
            ls -lh dist/ package.json .ebextensions || echo "Required files missing"
            if [ -f .cache_deploy_done ]; then
              echo "‚ö†Ô∏è  Backend deploy cache exists, skipping deploy"
            else
              zip -r deploy.zip dist node_modules package.json .ebextensions
              echo "Package size: $(du -sh deploy.zip)"
              eb deploy ${EB_ENVIRONMENT_NAME}
              touch .cache_deploy_done
              echo "‚úÖ Backend deployed successfully"
            fi

# -------------------------
# Workflows
# -------------------------
workflows:
  version: 2
  build-test-deploy:
    jobs:
      - frontend-job
      - backend-job:
          requires:
            - frontend-job
      - deploy-frontend:
          requires:
            - backend-job
      - deploy-backend:
          requires:
            - deploy-frontend
