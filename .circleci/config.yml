version: 2.1

# ================================================
# EXECUTORS - Reusable execution environments
# ================================================
executors:
  node-browsers:
    docker:
      - image: cimg/node:20.17-browsers
    working_directory: ~/project
    environment:
      NODE_ENV: test

  aws-cli:
    docker:
      - image: cimg/aws:2024.03
    working_directory: ~/project

# ================================================
# JOBS - Individual units of work
# ================================================
jobs:
  test-angular-app:
    executor: node-browsers
    steps:
      - checkout
      
      # Restore cached dependencies
      - restore_cache:
          name: Restore npm dependencies cache
          keys:
            - v1-testing-deps-{{ checksum "testing/package-lock.json" }}
            - v1-testing-deps-
      
      # Install dependencies
      - run:
          name: Install Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing testing app dependencies..."
            echo "=========================================="
            cd testing
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Current directory: $(pwd)"
            echo "=========================================="
            echo "Package.json exists: $([ -f package.json ] && echo 'YES' || echo 'NO')"
            echo "Package-lock.json exists: $([ -f package-lock.json ] && echo 'YES' || echo 'NO')"
            echo "=========================================="
            echo "Running npm ci..."
            npm ci
            NPM_EXIT=$?
            echo "=========================================="
            echo "‚úÖ npm ci exit code: $NPM_EXIT"
            if [ $NPM_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: npm ci failed!"
              exit 1
            fi
            echo "=========================================="
      
      # Save dependencies to cache
      - save_cache:
          name: Save npm dependencies cache
          key: v1-testing-deps-{{ checksum "testing/package-lock.json" }}
          paths:
            - testing/node_modules
      
      # Verify installation
      - run:
          name: Verify Installation
          command: |
            echo "=========================================="
            echo "üîç Verifying testing app installation..."
            echo "=========================================="
            cd testing
            echo "Total packages in node_modules: $(ls node_modules 2>/dev/null | wc -l)"
            echo "----------------------------------------"
            echo "Checking @angular/cli installation:"
            npm list @angular/cli || echo "‚ö†Ô∏è @angular/cli not found in npm list"
            echo "----------------------------------------"
            echo "Checking executables in .bin directory:"
            if [ -d "node_modules/.bin" ]; then
              echo "‚úÖ node_modules/.bin exists"
              echo "Executables count: $(ls node_modules/.bin 2>/dev/null | wc -l)"
              ls -la node_modules/.bin | grep -E "ng|karma" || echo "‚ö†Ô∏è ng or karma not found"
            else
              echo "‚ùå node_modules/.bin directory NOT FOUND!"
            fi
            echo "=========================================="
      
      # Run unit tests
      - run:
          name: Run Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running testing app unit tests..."
            echo "=========================================="
            cd testing
            export CHROME_BIN=$(node -p "require('puppeteer').executablePath()")
            echo "Chrome binary path: $CHROME_BIN"
            echo "Chrome exists: $([ -f "$CHROME_BIN" ] && echo 'YES' || echo 'NO')"
            echo "----------------------------------------"
            echo "Starting Karma test runner..."
            npm run test:ci
            TEST_EXIT=$?
            echo "=========================================="
            echo "‚úÖ Test exit code: $TEST_EXIT"
            if [ $TEST_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: Tests failed!"
              exit 1
            fi
            echo "All tests passed successfully!"
            echo "=========================================="
      
      # Build application
      - run:
          name: Build Application
          command: |
            echo "=========================================="
            echo "üèóÔ∏è Building testing app for production..."
            echo "=========================================="
            cd testing
            npm run build --configuration=production
            BUILD_EXIT=$?
            echo "=========================================="
            echo "‚úÖ Build exit code: $BUILD_EXIT"
            if [ $BUILD_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: Build failed!"
              exit 1
            fi
            echo "Checking build output:"
            if [ -d "dist" ]; then
              echo "‚úÖ dist directory created"
              echo "Build size: $(du -sh dist)"
              echo "Files in dist: $(find dist -type f | wc -l)"
              ls -la dist/
            else
              echo "‚ùå dist directory not found!"
              exit 1
            fi
            echo "=========================================="
      
      # Store test results
      - store_test_results:
          path: testing/coverage
      
      # Store test coverage artifacts
      - store_artifacts:
          path: testing/coverage
          destination: coverage
      
      # Store build artifacts
      - store_artifacts:
          path: testing/dist
          destination: dist

  # ================================================
  # UDACITY WEB-APP
  # ================================================
  udacity-web-app:
    executor: node-browsers
    steps:
      - checkout
      
      # Restore cached dependencies
      - restore_cache:
          name: Restore npm dependencies cache
          keys:
            - v1-web-app-deps-{{ checksum "web-app/package-lock.json" }}
            - v1-web-app-deps-
      
      # Install dependencies
      - run:
          name: Install Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing web-app dependencies..."
            echo "=========================================="
            cd web-app
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Current directory: $(pwd)"
            echo "=========================================="
            echo "Package.json exists: $([ -f package.json ] && echo 'YES' || echo 'NO')"
            echo "Package-lock.json exists: $([ -f package-lock.json ] && echo 'YES' || echo 'NO')"
            echo "=========================================="
            echo "Running npm ci..."
            npm ci 2>&1 | tee /tmp/npm-ci.log
            NPM_EXIT=$?
            echo "=========================================="
            echo "‚úÖ npm ci exit code: $NPM_EXIT"
            if [ $NPM_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: npm ci failed!"
              exit 1
            fi
            echo "=========================================="
      
      # Save dependencies to cache
      - save_cache:
          name: Save npm dependencies cache
          key: v1-web-app-deps-{{ checksum "web-app/package-lock.json" }}
          paths:
            - web-app/node_modules
      
      # Verify installation
      - run:
          name: Verify Installation
          command: |
            echo "=========================================="
            echo "üîç Verifying web-app installation..."
            echo "=========================================="
            cd web-app
            echo "Total packages in node_modules: $(ls node_modules 2>/dev/null | wc -l)"
            echo "----------------------------------------"
            echo "Checking @angular/cli installation:"
            npm list @angular/cli || echo "‚ö†Ô∏è @angular/cli not found in npm list"
            echo "----------------------------------------"
            echo "Checking executables in .bin directory:"
            if [ -d "node_modules/.bin" ]; then
              echo "‚úÖ node_modules/.bin exists"
              echo "Executables count: $(ls node_modules/.bin 2>/dev/null | wc -l)"
              ls -la node_modules/.bin | grep -E "ng|karma" || echo "‚ö†Ô∏è ng or karma not found"
            else
              echo "‚ùå node_modules/.bin directory NOT FOUND!"
            fi
            echo "=========================================="
      
      # Run unit tests
      - run:
          name: Run Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running web-app unit tests..."
            echo "=========================================="
            cd web-app
            export CHROME_BIN=$(node -p "require('puppeteer').executablePath()")
            echo "Chrome binary path: $CHROME_BIN"
            echo "Chrome exists: $([ -f "$CHROME_BIN" ] && echo 'YES' || echo 'NO')"
            echo "----------------------------------------"
            echo "Starting Karma test runner..."
            npm run test:ci
            TEST_EXIT=$?
            echo "=========================================="
            echo "‚úÖ Test exit code: $TEST_EXIT"
            if [ $TEST_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: Tests failed!"
              exit 1
            fi
            echo "All tests passed successfully!"
            echo "=========================================="
      
      # Build application
      - run:
          name: Build Application
          command: |
            echo "=========================================="
            echo "üèóÔ∏è Building web-app for production..."
            echo "=========================================="
            cd web-app
            npm run build --configuration=production
            BUILD_EXIT=$?
            echo "=========================================="
            echo "‚úÖ Build exit code: $BUILD_EXIT"
            if [ $BUILD_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: Build failed!"
              exit 1
            fi
            echo "Checking build output:"
            if [ -d "dist" ]; then
              echo "‚úÖ dist directory created"
              echo "Build size: $(du -sh dist)"
              echo "Files in dist: $(find dist -type f | wc -l)"
            else
              echo "‚ùå dist directory not found!"
              exit 1
            fi
            echo "=========================================="
      
      # Store test results
      - store_test_results:
          path: web-app/coverage
      
      # Store test coverage artifacts
      - store_artifacts:
          path: web-app/coverage
          destination: coverage
      
      # Store build artifacts
      - store_artifacts:
          path: web-app/dist
          destination: dist
      
      # Persist build artifacts for deployment
      - persist_to_workspace:
          root: ~/project
          paths:
            - web-app/dist

  udacity-web-api:
    executor: node-browsers
    steps:
      - checkout
      
      # Restore cached dependencies
      - restore_cache:
          name: Restore npm dependencies cache
          keys:
            - v1-web-api-deps-{{ checksum "web-api/package-lock.json" }}
            - v1-web-api-deps-
      
      # Install dependencies
      - run:
          name: Install Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing web-api dependencies..."
            echo "=========================================="
            cd web-api
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Current directory: $(pwd)"
            echo "=========================================="
            echo "Package.json exists: $([ -f package.json ] && echo 'YES' || echo 'NO')"
            echo "Package-lock.json exists: $([ -f package-lock.json ] && echo 'YES' || echo 'NO')"
            echo "=========================================="
            echo "Running npm ci..."
            npm ci
            NPM_EXIT=$?
            echo "=========================================="
            echo "‚úÖ npm ci exit code: $NPM_EXIT"
            if [ $NPM_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: npm ci failed!"
              exit 1
            fi
            echo "Total packages installed: $(ls node_modules 2>/dev/null | wc -l)"
            echo "=========================================="
      
      # Save dependencies to cache
      - save_cache:
          name: Save npm dependencies cache
          key: v1-web-api-deps-{{ checksum "web-api/package-lock.json" }}
          paths:
            - web-api/node_modules
      
      # Verify installation
      - run:
          name: Verify Installation
          command: |
            echo "=========================================="
            echo "üîç Verifying web-api installation..."
            echo "=========================================="
            cd web-api
            echo "Checking installed packages (depth=0):"
            npm list --depth=0 || echo "‚ö†Ô∏è Some peer dependency warnings (expected)"
            echo "=========================================="
      
      # Run unit tests
      - run:
          name: Run Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running web-api unit tests..."
            echo "=========================================="
            cd web-api
            npm test
            TEST_EXIT=$?
            echo "=========================================="
            echo "‚úÖ Test exit code: $TEST_EXIT"
            if [ $TEST_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: Tests failed!"
              exit 1
            fi
            echo "All tests passed successfully!"
            echo "=========================================="
      
      # Build application
      - run:
          name: Build Application
          command: |
            echo "=========================================="
            echo "üèóÔ∏è Building web-api..."
            echo "=========================================="
            cd web-api
            npm run build
            BUILD_EXIT=$?
            echo "=========================================="
            echo "‚úÖ Build exit code: $BUILD_EXIT"
            if [ $BUILD_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: Build failed!"
              exit 1
            fi
            echo "Checking build output:"
            if [ -d "dist" ]; then
              echo "‚úÖ dist directory created"
              echo "Build size: $(du -sh dist)"
              echo "Files in dist: $(find dist -type f | wc -l)"
            else
              echo "‚ùå dist directory not found!"
              exit 1
            fi
            echo "=========================================="
      
      # Store build artifacts
      - store_artifacts:
          path: web-api/dist
          destination: dist
      
      # Persist build artifacts for deployment
      - persist_to_workspace:
          root: ~/project
          paths:
            - web-api/dist

  # ================================================
  # DEPLOY FRONTEND TO AWS S3 & CloudFront
  # ================================================
  deploy-frontend:
    executor: aws-cli
    steps:
      - checkout
      
      - attach_workspace:
          at: ~/project
      
      - run:
          name: Install Node.js
          command: |
            echo "=========================================="
            echo "üì¶ Installing Node.js for frontend build..."
            echo "=========================================="
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "=========================================="
      
      - restore_cache:
          keys:
            - v1-web-app-deps-{{ checksum "web-app/package-lock.json" }}
            - v1-web-app-deps-
      
      - run:
          name: Rebuild Frontend for Production
          command: |
            echo "=========================================="
            echo "üèóÔ∏è Rebuilding frontend for deployment..."
            echo "=========================================="
            cd web-app
            npm ci
            npm run build --configuration=production
            echo "=========================================="
            echo "Build artifacts:"
            ls -lah dist/
            echo "Total files: $(find dist -type f | wc -l)"
            echo "Total size: $(du -sh dist)"
            echo "=========================================="
      
      - run:
          name: Deploy to AWS S3
          command: |
            echo "=========================================="
            echo "‚òÅÔ∏è Deploying frontend to AWS S3..."
            echo "=========================================="
            
            # Debug: Show environment info
            echo "üìã AWS Configuration Debug:"
            echo "AWS CLI version: $(aws --version)"
            echo "----------------------------------------"
            
            # Validate required environment variables with detailed output
            echo "üîç Checking AWS_S3_BUCKET..."
            if [ -z "${AWS_S3_BUCKET}" ]; then
              echo "‚ùå ERROR: AWS_S3_BUCKET environment variable is not set!"
              echo "Available env vars starting with AWS:"
              env | grep "^AWS" | grep -v "SECRET" | grep -v "KEY" || echo "No AWS_* variables found"
              exit 1
            else
              echo "‚úÖ AWS_S3_BUCKET is set: ${AWS_S3_BUCKET}"
            fi
            
            echo "üîç Checking AWS_DEFAULT_REGION..."
            if [ -z "${AWS_DEFAULT_REGION}" ]; then
              echo "‚ùå ERROR: AWS_DEFAULT_REGION environment variable is not set!"
              echo "Available env vars starting with AWS:"
              env | grep "^AWS" | grep -v "SECRET" | grep -v "KEY" || echo "No AWS_* variables found"
              exit 1
            else
              echo "‚úÖ AWS_DEFAULT_REGION is set: ${AWS_DEFAULT_REGION}"
            fi
            
            echo "=========================================="
            echo "S3 Bucket: ${AWS_S3_BUCKET}"
            echo "AWS Region: ${AWS_DEFAULT_REGION}"
            echo "----------------------------------------"
            cd web-app
            echo "üìÇ Current directory: $(pwd)"
            echo "üì¶ Checking dist directory:"
            if [ -d "dist" ]; then
              echo "‚úÖ dist directory exists"
              echo "Files to upload: $(find dist -type f | wc -l)"
              echo "Total size: $(du -sh dist)"
            else
              echo "‚ùå ERROR: dist directory not found!"
              exit 1
            fi
            echo "=========================================="
            echo "üöÄ Starting S3 sync..."
            echo "Command: aws s3 sync dist/ s3://${AWS_S3_BUCKET}/ --delete --acl public-read --cache-control max-age=86400"
            aws s3 sync dist/ s3://${AWS_S3_BUCKET}/ \
              --delete \
              --acl public-read \
              --cache-control "max-age=86400"
            SYNC_EXIT=$?
            echo "=========================================="
            echo "‚úÖ S3 sync exit code: $SYNC_EXIT"
            if [ $SYNC_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: S3 sync failed!"
              exit 1
            fi
            echo "Files uploaded successfully to S3!"
            echo "=========================================="
      
      - run:
          name: Invalidate CloudFront Cache
          command: |
            echo "=========================================="
            echo "üîÑ Invalidating CloudFront cache..."
            echo "=========================================="
            
            # Validate required environment variable
            if [ -z "${AWS_CLOUDFRONT_DISTRIBUTION_ID}" ]; then
              echo "‚ùå ERROR: AWS_CLOUDFRONT_DISTRIBUTION_ID environment variable is not set!"
              exit 1
            fi
            
            echo "Distribution ID: ${AWS_CLOUDFRONT_DISTRIBUTION_ID}"
            echo "=========================================="
            aws cloudfront create-invalidation \
              --distribution-id ${AWS_CLOUDFRONT_DISTRIBUTION_ID} \
              --paths "/*"
            INVALIDATION_EXIT=$?
            echo "=========================================="
            echo "‚úÖ Invalidation exit code: $INVALIDATION_EXIT"
            if [ $INVALIDATION_EXIT -ne 0 ]; then
              echo "‚ö†Ô∏è WARNING: CloudFront invalidation failed!"
            else
              echo "CloudFront cache invalidation initiated!"
            fi
            echo "=========================================="

  # ================================================
  # DEPLOY BACKEND TO AWS Elastic Beanstalk
  # ================================================
  deploy-backend:
    executor: aws-cli
    steps:
      - checkout
      
      - attach_workspace:
          at: ~/project
      
      - run:
          name: Install EB CLI
          command: |
            echo "=========================================="
            echo "üì¶ Installing AWS EB CLI..."
            echo "=========================================="
            pip3 install awsebcli --upgrade --user
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
            echo "EB CLI version: $(eb --version)"
            echo "=========================================="
      
      - run:
          name: Deploy to Elastic Beanstalk
          command: |
            echo "=========================================="
            echo "üöÄ Deploying backend to Elastic Beanstalk..."
            echo "=========================================="
            
            # Debug: Show all environment variables (masked sensitive ones)
            echo "üìã Environment Variables Debug:"
            echo "PATH: $PATH"
            echo "HOME: $HOME"
            echo "USER: $USER"
            echo "SHELL: $SHELL"
            echo "----------------------------------------"
            
            # Validate required environment variables with detailed output
            echo "üîç Checking EB_APP_NAME..."
            if [ -z "${EB_APP_NAME}" ]; then
              echo "‚ùå ERROR: EB_APP_NAME environment variable is not set!"
              echo "Available env vars starting with EB:"
              env | grep "^EB" || echo "No EB_* variables found"
              exit 1
            else
              echo "‚úÖ EB_APP_NAME is set: ${EB_APP_NAME}"
            fi
            
            echo "üîç Checking EB_ENV_NAME..."
            if [ -z "${EB_ENV_NAME}" ]; then
              echo "‚ùå ERROR: EB_ENV_NAME environment variable is not set!"
              echo "Available env vars starting with EB:"
              env | grep "^EB" || echo "No EB_* variables found"
              exit 1
            else
              echo "‚úÖ EB_ENV_NAME is set: ${EB_ENV_NAME}"
            fi
            
            echo "üîç Checking AWS_DEFAULT_REGION..."
            if [ -z "${AWS_DEFAULT_REGION}" ]; then
              echo "‚ùå ERROR: AWS_DEFAULT_REGION environment variable is not set!"
              echo "Available env vars starting with AWS:"
              env | grep "^AWS" | grep -v "SECRET" | grep -v "KEY" || echo "No AWS_* variables found"
              exit 1
            else
              echo "‚úÖ AWS_DEFAULT_REGION is set: ${AWS_DEFAULT_REGION}"
            fi
            
            echo "=========================================="
            cd web-api
            echo "üìÇ Current directory: $(pwd)"
            echo "EB Application: ${EB_APP_NAME}"
            echo "EB Environment: ${EB_ENV_NAME}"
            echo "AWS Region: ${AWS_DEFAULT_REGION}"
            echo "=========================================="
            echo "Current directory contents:"
            ls -lah
            echo "=========================================="
            echo "Checking dist directory:"
            if [ -d "dist" ]; then
              echo "‚úÖ dist directory found"
              echo "Files in dist: $(find dist -type f | wc -l)"
              ls -lah dist/
            else
              echo "‚ùå ERROR: dist directory not found!"
              exit 1
            fi
            echo "=========================================="
            echo "üîß Initializing EB (if needed)..."
            if [ ! -d ".elasticbeanstalk" ]; then
              echo "üìÅ Creating .elasticbeanstalk directory..."
              mkdir -p .elasticbeanstalk
              echo "üéØ Initializing EB application..."
              echo "Command: eb init ${EB_APP_NAME} --platform node.js --region ${AWS_DEFAULT_REGION}"
              eb init ${EB_APP_NAME} --platform node.js --region ${AWS_DEFAULT_REGION}
              EB_INIT_EXIT=$?
              echo "EB init exit code: $EB_INIT_EXIT"
              if [ $EB_INIT_EXIT -ne 0 ]; then
                echo "‚ùå ERROR: EB init failed!"
                exit 1
              fi
            else
              echo "‚úÖ EB already initialized"
              echo "Existing .elasticbeanstalk contents:"
              ls -la .elasticbeanstalk/
              if [ -f ".elasticbeanstalk/config.yml" ]; then
                echo "EB config.yml contents:"
                cat .elasticbeanstalk/config.yml
              fi
            fi
            echo "=========================================="
            echo "üéØ Setting default environment: ${EB_ENV_NAME}"
            echo "Command: eb use \"${EB_ENV_NAME}\""
            echo "EB_ENV_NAME length: ${#EB_ENV_NAME}"
            echo "EB_ENV_NAME value (quoted): '${EB_ENV_NAME}'"
            
            # Double check before using
            if [ -z "${EB_ENV_NAME}" ]; then
              echo "‚ùå ERROR: EB_ENV_NAME is empty or not set!"
              exit 1
            fi
            
            eb use "${EB_ENV_NAME}"
            EB_USE_EXIT=$?
            echo "EB use exit code: $EB_USE_EXIT"
            if [ $EB_USE_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: eb use command failed!"
              echo "Listing available environments:"
              eb list || echo "Failed to list environments"
              exit 1
            fi
            echo "=========================================="
            echo "üöÄ Deploying to environment: ${EB_ENV_NAME}"
            echo "Command: eb deploy \"${EB_ENV_NAME}\" --verbose"
            eb deploy "${EB_ENV_NAME}" --verbose
            DEPLOY_EXIT=$?
            echo "=========================================="
            echo "‚úÖ EB deploy exit code: $DEPLOY_EXIT"
            if [ $DEPLOY_EXIT -ne 0 ]; then
              echo "‚ùå ERROR: EB deployment failed!"
              exit 1
            fi
            echo "Backend deployed successfully!"
            echo "=========================================="
            echo "Getting environment info:"
            eb status ${EB_ENV_NAME}
            echo "=========================================="

# ================================================
# WORKFLOWS - Orchestrate job execution
# ================================================
workflows:
  version: 2
  test-build-deploy:
    jobs:
      # Test angular-app for debugging
      - test-angular-app:
          filters:
            branches:
              only:
                - main
      
      # TEMPORARILY DISABLED FOR DEBUGGING
      # - udacity-web-app:
      #     filters:
      #       branches:
      #         only:
      #           - main
      
      # - udacity-web-api:
      #     filters:
      #       branches:
      #         only:
      #           - main
      
      # Manual approval gate
      # TEMPORARILY DISABLED - requires udacity-web-app and udacity-web-api
      # - hold-for-approval:
      #     type: approval
      #     requires:
      #       - udacity-web-app
      #       - udacity-web-api
      #     filters:
      #       branches:
      #         only:
      #           - main
      
      # Deploy phase (parallel after approval)
      # TEMPORARILY DISABLED - requires hold-for-approval
      # - deploy-frontend:
      #     requires:
      #       - hold-for-approval
      #     filters:
      #       branches:
      #         only:
      #           - main
      
      # - deploy-backend:
      #     requires:
      #       - hold-for-approval
      #     filters:
      #       branches:
      #         only:
      #           - main
