version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:20.17
    working_directory: ~/repo

orbs:
  aws-cli: circleci/aws-cli@4.0.0
  eb: circleci/aws-elastic-beanstalk@2.0.1

jobs:
  # -------------------------
  # Frontend Build & Test
  # -------------------------
  frontend-job:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-frontend-node-{{ checksum "web-app/package-lock.json" }}
      - run:
          name: Install Frontend Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing frontend dependencies..."
            echo "=========================================="
            cd web-app
            echo "Current directory: $(pwd)"
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Listing files before install:"
            ls -la | head -20
            echo ""
            echo "Installing dependencies with npm ci..."
            npm ci --verbose
            echo ""
            echo "‚úÖ Dependencies installed successfully"
            echo "Verifying node_modules directory exists:"
            ls -ld node_modules
            echo ""
            echo "Checking node_modules/.bin directory:"
            ls -la node_modules/.bin/ | head -20
            echo ""
            echo "Verifying Angular CLI installation:"
            ls -la node_modules/.bin/ng
            echo ""
            echo "Testing Angular CLI:"
            ./node_modules/.bin/ng version
      - save_cache:
          paths:
            - web-app/node_modules
          key: v1-frontend-node-{{ checksum "web-app/package-lock.json" }}
      - run:
          name: Install Puppeteer Chromium
          command: |
            echo "=========================================="
            echo "üåê Installing Chromium for Puppeteer..."
            echo "=========================================="
            cd web-app
            echo "Current directory: $(pwd)"
            npx puppeteer browsers install chrome
            echo "‚úÖ Chromium installed successfully"
            echo "Chromium location:"
            ls -la ~/.cache/puppeteer/ || echo "Cache directory structure"
      - run:
          name: Run Frontend Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running frontend unit tests..."
            echo "=========================================="
            cd web-app
            echo "Current directory: $(pwd)"
            echo "Verifying ng binary exists:"
            ls -la node_modules/.bin/ng
            echo "Running tests directly with Angular CLI..."
            ./node_modules/.bin/ng test --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage
            echo "‚úÖ Tests completed successfully"
      - run:
          name: Build Frontend
          command: |
            echo "=========================================="
            echo "üèóÔ∏è  Building frontend..."
            echo "=========================================="
            cd web-app
            echo "Current directory: $(pwd)"
            echo "Building with Angular CLI..."
            ./node_modules/.bin/ng build
            echo "‚úÖ Build completed successfully"
            echo "Build output structure:"
            ls -la dist/
            echo "Build files:"
            find dist/ -type f | head -20
      - persist_to_workspace:
          root: ~/repo
          paths:
            - web-app/dist
            - web-app/node_modules
            - web-app/package.json
      - save_cache:
          paths:
            - web-app/dist
          key: v1-frontend-build-{{ checksum "web-app/dist" }}

  # -------------------------
  # Backend Build & Test
  # -------------------------
  backend-job:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-backend-node-{{ checksum "web-api/package-lock.json" }}
      - run:
          name: Install Backend Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing backend dependencies..."
            echo "=========================================="
            cd web-api
            echo "Current directory: $(pwd)"
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            npm ci
            echo "‚úÖ Dependencies installed successfully"
            echo "Installed packages count:"
            ls node_modules | wc -l
      - save_cache:
          paths:
            - web-api/node_modules
          key: v1-backend-node-{{ checksum "web-api/package-lock.json" }}
      - run:
          name: Run Backend Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running backend unit tests..."
            echo "=========================================="
            cd web-api
            echo "Current directory: $(pwd)"
            echo "Running tests..."
            npm test
            echo "‚úÖ Tests completed successfully"
      - run:
          name: Build Backend
          command: |
            echo "=========================================="
            echo "üèóÔ∏è  Building backend..."
            echo "=========================================="
            cd web-api
            echo "Current directory: $(pwd)"
            npm run build
            echo "‚úÖ Build completed successfully"
            echo "Build output:"
            ls -la dist/ || echo "Dist directory not found"
      - persist_to_workspace:
          root: ~/repo
          paths:
            - web-api/dist
            - web-api/node_modules
            - web-api/package.json
      - save_cache:
          paths:
            - web-api/dist
          key: v1-backend-build-{{ checksum "web-api/dist" }}

  # -------------------------
  # Deploy Frontend
  # -------------------------
  deploy-frontend:
    executor: node-executor
    steps:
      - checkout
      - aws-cli/setup
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - v1-frontend-build-{{ checksum "web-app/dist" }}
      - run:
          name: Check if Frontend Needs Deploy
          command: |
            if [ -d "web-app/dist" ] && [ "$(ls -A web-app/dist)" ]; then
              echo "Frontend build exists. Deploying..."
              cd web-app/dist
              aws s3 sync . s3://${AWS_S3_BUCKET} --delete
              echo "Invalidating CloudFront cache..."
              aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --paths "/*"
            else
              echo "No frontend changes detected. Skipping deploy."
            fi

  # -------------------------
  # Deploy Backend
  # -------------------------
  deploy-backend:
    executor: node-executor
    steps:
      - checkout
      - aws-cli/setup
      - eb/setup
      - attach_workspace:
          at: ~/repo
      - restore_cache:
          keys:
            - v1-backend-build-{{ checksum "web-api/dist" }}
      - run:
          name: Check if Backend Needs Deploy
          command: |
            if [ -d "web-api/dist" ] && [ "$(ls -A web-api/dist)" ]; then
              echo "Backend build exists. Preparing deployment package..."
              cd web-api
              zip -r deploy.zip dist node_modules package.json .ebextensions
              echo "Deploying backend to Elastic Beanstalk..."
              eb deploy ${EB_ENVIRONMENT_NAME}
            else
              echo "No backend changes detected. Skipping deploy."
            fi

# -------------------------
# Workflows
# -------------------------
workflows:
  version: 2
  build-test-deploy:
    jobs:
      # Parallel build & test
      - frontend-job:
          filters:
            branches:
              only:
                - main
                - develop
      - backend-job:
          filters:
            branches:
              only:
                - main
                - develop

      # Manual approval for production
      - hold-for-approval:
          type: approval
          requires:
            - frontend-job
            - backend-job
          filters:
            branches:
              only: main

      # Sequential deploys for production
      - deploy-frontend:
          requires:
            - hold-for-approval
          filters:
            branches:
              only: main
      - deploy-backend:
          requires:
            - deploy-frontend
          filters:
            branches:
              only: main

      # Sequential deploys for staging (develop branch)
      - deploy-frontend:
          name: deploy-frontend-staging
          requires:
            - frontend-job
          filters:
            branches:
              only: develop
      - deploy-backend:
          name: deploy-backend-staging
          requires:
            - deploy-frontend-staging
          filters:
            branches:
              only: develop
