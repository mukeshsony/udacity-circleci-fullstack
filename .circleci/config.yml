version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:20.17-browsers  # Next-gen Docker convenience image
    working_directory: ~/repo

jobs:
  # -------------------------
  # Frontend Build & Test
  # -------------------------
  frontend-job:
    executor: node-executor
    steps:
      - checkout

      # Restore frontend dependencies cache
      - restore_cache:
          keys:
            - v1-frontend-node-{{ checksum "web-app/package-lock.json" }}

      # Install frontend dependencies
      - run:
          name: Install Frontend Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing frontend dependencies..."
            echo "=========================================="
            cd web-app
            echo "Current directory: $(pwd)"
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Checking package files:"
            ls -lh package.json package-lock.json
            echo ""
            echo "Running npm ci..."
            npm ci --loglevel=info
            echo "‚úÖ Dependencies installed"
            echo ""
            echo "node_modules directory:"
            ls -ld node_modules
            echo "node_modules/.bin directory:"
            ls -l node_modules/.bin | head -10 || echo ".bin folder does not exist"

      - save_cache:
          paths:
            - web-app/node_modules
          key: v1-frontend-node-{{ checksum "web-app/package-lock.json" }}

      # Run frontend tests using local Angular CLI via npx
      - run:
          name: Run Frontend Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running frontend unit tests..."
            echo "=========================================="
            cd web-app
            echo "Current directory: $(pwd)"
            echo "Node modules bin path:"
            ls -l node_modules/.bin | head -10
            echo ""
            echo "Starting tests with ChromeHeadlessCI..."
            npx ng test --watch=false --browsers=ChromeHeadlessCI --code-coverage
            echo ""
            if [ -d coverage ]; then
              echo "Coverage report generated:"
              ls -lh coverage/
            fi

      # Build frontend using local Angular CLI
      - run:
          name: Build Frontend
          command: |
            echo "=========================================="
            echo "üèó Building frontend..."
            echo "=========================================="
            cd web-app
            echo "Starting production build..."
            npx ng build --configuration=production
            echo ""
            echo "‚úÖ Build completed successfully"
            echo "Build output:"
            ls -lh dist/
            du -sh dist/
            find dist/ -type f | head -20

      # Cache frontend build artifacts
      - save_cache:
          paths:
            - web-app/dist
          key: v1-frontend-build-{{ checksum "web-app/package-lock.json" }}

  # -------------------------
  # Backend Build & Test
  # -------------------------
  backend-job:
    executor: node-executor
    steps:
      - checkout

      # Cache backend dependencies
      - restore_cache:
          keys:
            - v1-backend-node-{{ checksum "web-api/package-lock.json" }}

      - run:
          name: Install Backend Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing backend dependencies..."
            echo "=========================================="
            cd web-api
            echo "Current directory: $(pwd)"
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Checking package files:"
            ls -lh package.json package-lock.json
            echo ""
            npm ci --loglevel=info
            echo "‚úÖ Dependencies installed"
            echo ""
            echo "node_modules directory:"
            ls -ld node_modules
            echo "node_modules/.bin directory:"
            ls -l node_modules/.bin | head -10 || echo ".bin folder does not exist"

      - save_cache:
          paths:
            - web-api/node_modules
          key: v1-backend-node-{{ checksum "web-api/package-lock.json" }}

      - run:
          name: Run Backend Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running backend unit tests..."
            echo "=========================================="
            cd web-api
            npm test
            echo "‚úÖ Backend tests completed successfully"

      - run:
          name: Build Backend
          command: |
            echo "=========================================="
            echo "üèó Building backend..."
            echo "=========================================="
            cd web-api
            npx tsc --version || echo "TypeScript not found"
            npm run build
            echo "‚úÖ Backend build completed"

      # Cache backend build artifacts
      - save_cache:
          paths:
            - web-api/dist
          key: v1-backend-build-{{ checksum "web-api/package-lock.json" }}

  # -------------------------
  # Frontend Deploy
  # -------------------------
  deploy-frontend:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Deploy Frontend
          command: |
            echo "üöÄ Deploying frontend..."
            cd web-app/dist
            if [ -f .cache_deploy_done ]; then
              echo "‚ö†Ô∏è  Frontend deploy cache exists, skipping deploy"
            else
              aws s3 sync . s3://${AWS_S3_BUCKET} --delete
              aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --paths "/*"
              touch .cache_deploy_done
              echo "‚úÖ Frontend deployed successfully"
            fi

  # -------------------------
  # Backend Deploy
  # -------------------------
  deploy-backend:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Deploy Backend
          command: |
            echo "üöÄ Deploying backend..."
            cd web-api
            if [ -f .cache_deploy_done ]; then
              echo "‚ö†Ô∏è  Backend deploy cache exists, skipping deploy"
            else
              zip -r deploy.zip dist node_modules package.json .ebextensions
              eb deploy ${EB_ENVIRONMENT_NAME}
              touch .cache_deploy_done
              echo "‚úÖ Backend deployed successfully"
            fi

# -------------------------
# Workflows
# -------------------------
workflows:
  version: 2
  build-test-deploy:
    jobs:
      - frontend-job
      - backend-job:
          requires:
            - frontend-job
      - deploy-frontend:
          requires:
            - backend-job
      - deploy-backend:
          requires:
            - deploy-frontend
