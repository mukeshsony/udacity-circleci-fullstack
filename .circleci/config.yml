version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:20.17-browsers
    working_directory: ~/repo

jobs:
  # ------------------------------------------------
  # ğŸ§± FRONTEND JOB
  # ------------------------------------------------
  frontend-job:
    executor: node-executor
    steps:
      - checkout

      - restore_cache:
          keys:
            - v3-frontend-node-{{ checksum "web-app/package-lock.json" }}
            - v3-frontend-node-

      - run:
          name: ğŸ“¦ Clean Install Frontend Dependencies
          command: |
            echo "ğŸ“‚ Listing root directory contents:"
            ls -la
            echo "=========================================="
            echo "ğŸ“¦ Cleaning node_modules and installing frontend dependencies..."
            cd web-app
            rm -rf node_modules
            npm install
            echo "âœ… Dependencies installed."
            echo "ğŸ“‚ Checking node_modules/.bin:"
            ls -la node_modules/.bin | head -20
            echo "ğŸ” Checking if @angular/cli is installed:"
            npm list @angular/cli
            echo "ğŸ” Verifying Angular CLI executable:"
            which ng || echo "ng not found"
            npx ng version

      - save_cache:
          paths:
            - web-app/node_modules
          key: v3-frontend-node-{{ checksum "web-app/package-lock.json" }}

      - run:
          name: ğŸ§ª Run Frontend Unit Tests
          command: |
            echo "=========================================="
            echo "ğŸ§ª Running frontend unit tests..."
            echo "=========================================="
            cd web-app
            npm run test:ci

      - run:
          name: ğŸ—ï¸ Build Frontend
          command: |
            echo "=========================================="
            echo "ğŸ—ï¸ Building frontend..."
            echo "=========================================="
            cd web-app
            npm run build -- --configuration production
            echo "âœ… Frontend build complete."

      - save_cache:
          key: v3-frontend-dist-{{ checksum "web-app/package-lock.json" }}
          paths:
            - web-app/dist

      - store_artifacts:
          path: web-app/dist
          destination: frontend-dist
      - store_artifacts:
          path: web-app/coverage
          destination: frontend-coverage

  # ------------------------------------------------
  # âš™ï¸ BACKEND JOB
  # ------------------------------------------------
  backend-job:
    executor: node-executor
    steps:
      - checkout

      - restore_cache:
          keys:
            - v3-backend-node-{{ checksum "web-api/package-lock.json" }}
            - v3-backend-node-

      - run:
          name: ğŸ“¦ Install Backend Dependencies
          command: |
            echo "=========================================="
            echo "ğŸ“¦ Installing backend dependencies..."
            echo "=========================================="
            cd web-api
            npm ci
            echo "âœ… Dependencies installed."

      - save_cache:
          paths:
            - web-api/node_modules
          key: v3-backend-node-{{ checksum "web-api/package-lock.json" }}

      - run:
          name: ğŸ§ª Run Backend Unit Tests
          command: |
            echo "=========================================="
            echo "ğŸ§ª Running backend unit tests..."
            echo "=========================================="
            cd web-api
            npm test

      - run:
          name: ğŸ—ï¸ Build Backend
          command: |
            echo "=========================================="
            echo "ğŸ—ï¸ Building backend..."
            echo "=========================================="
            cd web-api
            npm run build
            echo "âœ… Backend build complete."

      - save_cache:
          key: v3-backend-dist-{{ checksum "web-api/package-lock.json" }}
          paths:
            - web-api/dist

      - store_artifacts:
          path: web-api/dist
          destination: backend-dist

# ------------------------------------------------
# ğŸ”„ WORKFLOW: sequential build/test/deploy
# ------------------------------------------------
workflows:
  version: 2
  build-test-deploy:
    jobs:
      - frontend-job
      - backend-job:
          requires:
            - frontend-job
