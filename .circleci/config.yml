version: 2.1

executors:
  node-executor:
    docker:
      - image: circleci/node:20   # Node.js environment
    working_directory: ~/repo

jobs:
  # -------------------------
  # Frontend Build & Test
  # -------------------------
  frontend-job:
    executor: node-executor
    steps:
      - checkout

      # Cache frontend dependencies
      - restore_cache:
          keys:
            - v1-frontend-node-{{ checksum "web-app/package-lock.json" }}
      - run:
          name: Install Angular CLI
          command: |
            echo "=========================================="
            echo "üîß Installing Angular CLI globally..."
            echo "=========================================="
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Current directory: $(pwd)"
            npm install -g @angular/cli
            echo "Verifying Angular CLI installation:"
            which ng
            ng version
            echo "‚úÖ Angular CLI installed globally"
      - run:
          name: Install Frontend Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing frontend dependencies..."
            echo "=========================================="
            cd web-app
            echo "Current directory: $(pwd)"
            echo "Checking package files:"
            ls -lh package.json package-lock.json
            echo ""
            echo "Starting npm ci..."
            npm ci --loglevel=info
            echo ""
            echo "‚úÖ Dependencies installed"
            echo "Verifying installation:"
            echo "  - node_modules directory:"
            ls -ld node_modules
            echo "  - Package count: $(ls node_modules | wc -l)"
            echo "  - node_modules/.bin directory:"
            ls -l node_modules/.bin | head -10 || echo ".bin folder does not exist"
            echo "  - Angular CLI in node_modules:"
            ls -lh node_modules/.bin/ng 2>/dev/null || echo "ng binary not found in node_modules"
      - save_cache:
          paths:
            - web-app/node_modules
          key: v1-frontend-node-{{ checksum "web-app/package-lock.json" }}

      # Run frontend tests using global ng
      - run:
          name: Run Frontend Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running frontend unit tests..."
            echo "=========================================="
            cd web-app
            echo "Current directory: $(pwd)"
            echo "Using Angular CLI from: $(which ng)"
            echo "Angular CLI version:"
            ng version
            echo ""
            echo "Starting tests with ChromeHeadless..."
            ng test --watch=false --browsers=ChromeHeadless --code-coverage
            echo ""
            echo "‚úÖ Tests completed successfully"
            if [ -d coverage ]; then
              echo "Coverage report generated:"
              ls -lh coverage/
            fi

      # Build frontend using global ng
      - run:
          name: Build Frontend
          command: |
            echo "=========================================="
            echo "üèó Building frontend..."
            echo "=========================================="
            cd web-app
            echo "Current directory: $(pwd)"
            echo "Starting production build..."
            ng build --configuration=production
            echo ""
            echo "‚úÖ Build completed successfully"
            echo "Build output:"
            ls -lh dist/
            echo ""
            echo "Build size:"
            du -sh dist/
            echo "Build files:"
            find dist/ -type f | head -20

      # Cache frontend build artifacts for deploy
      - save_cache:
          paths:
            - web-app/dist
          key: v1-frontend-build-{{ checksum "web-app/package-lock.json" }}

  # -------------------------
  # Backend Build & Test
  # -------------------------
  backend-job:
    executor: node-executor
    steps:
      - checkout

      # Cache backend dependencies
      - restore_cache:
          keys:
            - v1-backend-node-{{ checksum "web-api/package-lock.json" }}
      - run:
          name: Install Backend Dependencies
          command: |
            echo "=========================================="
            echo "üì¶ Installing backend dependencies..."
            echo "=========================================="
            cd web-api
            echo "Current directory: $(pwd)"
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Checking package files:"
            ls -lh package.json package-lock.json
            echo ""
            echo "Starting npm ci..."
            npm ci --loglevel=info
            echo ""
            echo "‚úÖ Dependencies installed"
            echo "Verifying installation:"
            echo "  - node_modules directory:"
            ls -ld node_modules
            echo "  - Package count: $(ls node_modules | wc -l)"
            echo "  - node_modules/.bin directory:"
            ls -l node_modules/.bin | head -10 || echo ".bin folder does not exist"
      - save_cache:
          paths:
            - web-api/node_modules
          key: v1-backend-node-{{ checksum "web-api/package-lock.json" }

      # Run backend tests
      - run:
          name: Run Backend Unit Tests
          command: |
            echo "=========================================="
            echo "üß™ Running backend unit tests..."
            echo "=========================================="
            cd web-api
            echo "Current directory: $(pwd)"
            echo "Test configuration:"
            cat tests/support/jasmine.json 2>/dev/null || echo "jasmine.json not found"
            echo ""
            echo "Starting tests..."
            npm test
            echo ""
            echo "‚úÖ Tests completed successfully"

      # Build backend (TypeScript optional)
      - run:
          name: Build Backend
          command: |
            echo "=========================================="
            echo "üèó Building backend..."
            echo "=========================================="
            cd web-api
            echo "Current directory: $(pwd)"
            echo "TypeScript version:"
            npx tsc --version || echo "TypeScript not found"
            echo ""
            echo "Starting build..."
            npm run build
            echo ""
            echo "‚úÖ Build completed successfully"
            if [ -d dist ]; then
              echo "Build output:"
              ls -lh dist/
              echo "Build size:"
              du -sh dist/
            fi

      # Cache backend build artifacts
      - save_cache:
          paths:
            - web-api/dist
          key: v1-backend-build-{{ checksum "web-api/package-lock.json" }}

  # -------------------------
  # Frontend Deploy
  # -------------------------
  deploy-frontend:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Deploy Frontend
          command: |
            echo "=========================================="
            echo "üöÄ Deploying frontend..."
            echo "=========================================="
            echo "Current directory: $(pwd)"
            echo "Checking dist folder:"
            ls -lh web-app/dist/ || echo "dist folder not found"
            cd web-app/dist
            echo ""
            # Skip deploy if nothing changed
            if [ -f .cache_deploy_done ]; then
              echo "‚ö†Ô∏è  Frontend deploy cache exists, skipping deploy"
            else
              echo "Deploying to S3 bucket: ${AWS_S3_BUCKET}"
              aws s3 sync . s3://${AWS_S3_BUCKET} --delete
              echo ""
              echo "Creating CloudFront invalidation..."
              aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --paths "/*"
              touch .cache_deploy_done
              echo ""
              echo "‚úÖ Frontend deployed successfully"
            fi

  # -------------------------
  # Backend Deploy
  # -------------------------
  deploy-backend:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo
      - run:
          name: Deploy Backend
          command: |
            echo "=========================================="
            echo "üöÄ Deploying backend..."
            echo "=========================================="
            cd web-api
            echo "Current directory: $(pwd)"
            echo "Checking deployment files:"
            ls -lh dist/ package.json 2>/dev/null || echo "Required files not found"
            echo ""
            # Skip deploy if nothing changed
            if [ -f .cache_deploy_done ]; then
              echo "‚ö†Ô∏è  Backend deploy cache exists, skipping deploy"
            else
              echo "Creating deployment package..."
              zip -r deploy.zip dist node_modules package.json .ebextensions
              echo "Package size: $(du -sh deploy.zip)"
              echo ""
              echo "Deploying to Elastic Beanstalk: ${EB_ENVIRONMENT_NAME}"
              eb deploy ${EB_ENVIRONMENT_NAME}
              touch .cache_deploy_done
              echo ""
              echo "‚úÖ Backend deployed successfully"
            fi

# -------------------------
# Workflows
# -------------------------
workflows:
  version: 2
  build-test-deploy:
    jobs:
      - frontend-job
      - backend-job:
          requires:
            - frontend-job
      - deploy-frontend:
          requires:
            - backend-job
      - deploy-backend:
          requires:
            - deploy-frontend
