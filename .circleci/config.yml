version: 2.1

executors:
  node-executor:
    docker:
      - image: circleci/node:20  # Updated next-gen Node.js image
    working_directory: ~/repo

jobs:
  # -------------------------
  # Frontend Build & Test
  # -------------------------
  frontend-job:
    executor: node-executor
    steps:
      - checkout

      # Restore frontend dependencies cache
      - restore_cache:
          keys:
            - v1-frontend-node-{{ checksum "web-app/package-lock.json" }}

      # Install frontend dependencies (including devDependencies)
      - run:
          name: Install Frontend Dependencies
          command: |
            echo "=========================================="
            echo "ğŸ“¦ Installing frontend dependencies..."
            echo "=========================================="
            cd web-app
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Environment Information:"
            echo "  Working directory: $(pwd)"
            echo "  Node version: $(node --version)"
            echo "  NPM version: $(npm --version)"
            echo "  NPM config (prefix): $(npm config get prefix)"
            echo "  User: $(whoami)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Package files check:"
            ls -lh package.json package-lock.json
            echo ""
            echo "Setting NODE_ENV to empty..."
            unset NODE_ENV
            echo "NODE_ENV: ${NODE_ENV:-'(empty)'}"
            echo ""
            echo "Starting npm ci with dev dependencies..."
            npm ci --include=dev --loglevel=info
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Installation Complete - Verification:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "1. node_modules directory:"
            ls -ld node_modules
            echo ""
            echo "2. Total packages installed:"
            ls node_modules | wc -l
            echo ""
            echo "3. First 20 packages:"
            ls node_modules | head -20
            echo ""
            echo "4. Angular packages:"
            ls node_modules | grep angular
            echo ""
            echo "5. .bin directory:"
            if [ -d "node_modules/.bin" ]; then
              echo "   âœ… .bin exists"
              echo "   Total binaries: $(ls node_modules/.bin | wc -l)"
              echo "   Binaries (first 20):"
              ls node_modules/.bin | head -20
            else
              echo "   âŒ .bin does NOT exist"
            fi
            echo ""
            echo "6. Angular CLI check:"
            if [ -f "node_modules/.bin/ng" ]; then
              echo "   âœ… ng binary found"
              ls -lh node_modules/.bin/ng
              echo "   Testing ng binary:"
              node_modules/.bin/ng version || echo "   ng version failed"
            else
              echo "   âŒ ng binary NOT found"
              echo "   Checking @angular/cli package:"
              ls -la node_modules/@angular/cli 2>/dev/null | head -5 || echo "   @angular/cli package not found"
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Save frontend dependencies cache
      - save_cache:
          paths:
            - web-app/node_modules
          key: v1-frontend-node-{{ checksum "web-app/package-lock.json" }}

      # Run frontend unit tests using local Angular CLI via npx
      - run:
          name: Run Frontend Unit Tests
          command: |
            echo "=========================================="
            echo "ğŸ§ª Running frontend unit tests..."
            echo "=========================================="
            cd web-app
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Pre-test checks:"
            echo "  Current directory: $(pwd)"
            echo "  Chrome available: $(which google-chrome-stable google-chrome chromium 2>/dev/null || echo 'Not found')"
            echo ""
            echo "Checking Angular CLI availability:"
            echo "  1. Via npx:"
            npx ng version || echo "  npx ng failed"
            echo ""
            echo "  2. Direct binary:"
            ./node_modules/.bin/ng version 2>/dev/null || echo "  Direct ng binary failed"
            echo ""
            echo "  3. Via npm script (package.json):"
            npm run ng -- version 2>/dev/null || echo "  npm run ng failed"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Starting tests with ChromeHeadless..."
            npx ng test --watch=false --browsers=ChromeHeadless --code-coverage
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Tests completed"
            if [ -d coverage ]; then
              echo "Coverage report:"
              ls -lh coverage/
              echo "Coverage summary:"
              cat coverage/*/index.html | grep -A 5 "coverage-summary" || echo "Could not extract summary"
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Build frontend for deploy
      - run:
          name: Build Frontend
          command: |
            echo "=========================================="
            echo "ğŸ— Building frontend..."
            echo "=========================================="
            cd web-app
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Starting production build..."
            echo "  Current directory: $(pwd)"
            echo "  Build command: npx ng build --configuration=production"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            npx ng build --configuration=production
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Build completed successfully"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Build artifacts:"
            ls -lh dist/
            echo ""
            echo "Total build size:"
            du -sh dist/
            echo ""
            echo "File count:"
            find dist/ -type f | wc -l
            echo ""
            echo "Top 10 largest files:"
            find dist/ -type f -exec ls -lh {} \; | sort -k5 -hr | head -10
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Cache frontend build artifacts
      - save_cache:
          paths:
            - web-app/dist
          key: v1-frontend-build-{{ checksum "web-app/package-lock.json" }}

  # -------------------------
  # Backend Build & Test
  # -------------------------
  backend-job:
    executor: node-executor
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-backend-node-{{ checksum "web-api/package-lock.json" }}
      - run:
          name: Install Backend Dependencies
          command: |
            echo "=========================================="
            echo "ğŸ“¦ Installing backend dependencies..."
            echo "=========================================="
            cd web-api
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Environment:"
            echo "  Directory: $(pwd)"
            echo "  Node: $(node --version)"
            echo "  NPM: $(npm --version)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            unset NODE_ENV
            npm ci --include=dev --loglevel=info
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Backend dependencies installed"
            echo "  Packages: $(ls node_modules | wc -l)"
            echo "  Binaries: $(ls node_modules/.bin 2>/dev/null | wc -l || echo '0')"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - save_cache:
          paths:
            - web-api/node_modules
          key: v1-backend-node-{{ checksum "web-api/package-lock.json" }}

      # Run backend tests
      - run:
          name: Run Backend Unit Tests
          command: |
            echo "=========================================="
            echo "ğŸ§ª Running backend unit tests..."
            echo "=========================================="
            cd web-api
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Running Jasmine tests..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            npm test
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Backend tests completed"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Build backend
      - run:
          name: Build Backend
          command: |
            echo "=========================================="
            echo "ğŸ— Building backend..."
            echo "=========================================="
            cd web-api
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "TypeScript compilation..."
            echo "  TypeScript version: $(npx tsc --version 2>/dev/null || echo 'Not found')"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            npm run build
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            if [ -d dist ]; then
              echo "âœ… Build completed"
              echo "  Output directory: dist/"
              echo "  Files: $(find dist/ -type f | wc -l)"
              echo "  Size: $(du -sh dist/ | cut -f1)"
              echo ""
              echo "  Contents:"
              ls -lh dist/ | head -20
            else
              echo "âš ï¸  dist/ directory not found"
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - save_cache:
          paths:
            - web-api/dist
          key: v1-backend-build-{{ checksum "web-api/package-lock.json" }}

workflows:
  version: 2
  build-test-deploy:
    jobs:
      - frontend-job
      - backend-job:
          requires:
            - frontend-job
