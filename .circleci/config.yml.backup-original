version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:20.17-browsers
    working_directory: ~/repo

jobs:
  # ------------------------------------------------
  # ğŸ§± FRONTEND JOB
  # ------------------------------------------------
  frontend-job:
    executor: node-executor
    steps:
      - checkout

      - restore_cache:
          keys:
            - v5-frontend-node-{{ checksum "web-app/package.json" }}
            - v5-frontend-node-

      - run:
          name: ğŸ“¦ Install Frontend Dependencies
          command: |
            echo "=========================================="
            echo "ğŸ“¦ Installing frontend dependencies..."
            echo "=========================================="
            cd web-app
            echo "Node version: $(node -v)"
            echo "NPM version: $(npm -v)"
            echo "=========================================="
            echo "Checking package.json devDependencies:"
            cat package.json | grep -A 15 '"devDependencies"'
            echo "=========================================="
            echo "Current directory contents:"
            ls -la
            echo "=========================================="
            echo "Running npm install with full output..."
            npm install 2>&1 | tee /tmp/npm-install.log
            NPM_EXIT=$?
            echo "=========================================="
            echo "âœ… npm install exit code: $NPM_EXIT"
            echo "Last 50 lines of npm install output:"
            tail -50 /tmp/npm-install.log
            if [ $NPM_EXIT -ne 0 ]; then
              echo "ERROR: npm install failed!"
              exit 1
            fi
            echo "Regenerated package-lock.json lines: $(wc -l < package-lock.json)"
            echo "=========================================="
            echo "ï¿½ Checking installation results:"
            echo "Total packages in node_modules: $(ls node_modules 2>/dev/null | wc -l)"
            if [ -d "node_modules/.bin" ]; then
              echo "âœ… node_modules/.bin exists"
              echo "Executables in .bin: $(ls node_modules/.bin 2>/dev/null | wc -l)"
              ls -la node_modules/.bin | head -20
            else
              echo "âŒ node_modules/.bin directory NOT FOUND!"
              echo "Checking if node_modules exists: $([ -d "node_modules" ] && echo "YES" || echo "NO")"
            fi
            echo "=========================================="
            echo "ğŸ” Checking @angular/cli installation:"
            npm list @angular/cli || echo "âš ï¸ @angular/cli not found"

      - save_cache:
          paths:
            - web-app/node_modules
            - web-app/package-lock.json
          key: v5-frontend-node-{{ checksum "web-app/package.json" }}

      - run:
          name: ğŸ§ª Run Frontend Unit Tests
          command: |
            echo "=========================================="
            echo "ğŸ§ª Running frontend unit tests..."
            echo "=========================================="
            cd web-app
            npm run test:ci

      - run:
          name: ğŸ—ï¸ Build Frontend
          command: |
            echo "=========================================="
            echo "ğŸ—ï¸ Building frontend..."
            echo "=========================================="
            cd web-app
            npm run build -- --configuration production
            echo "âœ… Frontend build complete."

      - save_cache:
          key: v5-frontend-dist-{{ checksum "web-app/package.json" }}
          paths:
            - web-app/dist

      - store_artifacts:
          path: web-app/dist
          destination: frontend-dist
      - store_artifacts:
          path: web-app/coverage
          destination: frontend-coverage

  # ------------------------------------------------
  # âš™ï¸ BACKEND JOB
  # ------------------------------------------------
  backend-job:
    executor: node-executor
    steps:
      - checkout

      - restore_cache:
          keys:
            - v3-backend-node-{{ checksum "web-api/package-lock.json" }}
            - v3-backend-node-

      - run:
          name: ğŸ“¦ Install Backend Dependencies
          command: |
            echo "=========================================="
            echo "ğŸ“¦ Installing backend dependencies..."
            echo "=========================================="
            cd web-api
            npm ci
            echo "âœ… Dependencies installed."

      - save_cache:
          paths:
            - web-api/node_modules
          key: v3-backend-node-{{ checksum "web-api/package-lock.json" }}

      - run:
          name: ğŸ§ª Run Backend Unit Tests
          command: |
            echo "=========================================="
            echo "ğŸ§ª Running backend unit tests..."
            echo "=========================================="
            cd web-api
            npm test

      - run:
          name: ğŸ—ï¸ Build Backend
          command: |
            echo "=========================================="
            echo "ğŸ—ï¸ Building backend..."
            echo "=========================================="
            cd web-api
            npm run build
            echo "âœ… Backend build complete."

      - save_cache:
          key: v3-backend-dist-{{ checksum "web-api/package-lock.json" }}
          paths:
            - web-api/dist

      - store_artifacts:
          path: web-api/dist
          destination: backend-dist

# ------------------------------------------------
# ğŸ”„ WORKFLOW: sequential build/test/deploy
# ------------------------------------------------
workflows:
  version: 2
  build-test-deploy:
    jobs:
      - frontend-job
      - backend-job:
          requires:
            - frontend-job
